<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Import Excel vers Grist</title>
    <link rel="stylesheet" href="styles/style.css" />
  </head>

  <body>
    <div class="container">
      <!-- Selecteur de mode (visible uniquement en mode dev via ?mode=dev) -->
      <div class="mode-selector" id="mode-selector-wrapper">
        <label for="mode-selector">Mode :</label>
        <select id="mode-selector">
          <option value="public" selected>Utilisateur</option>
          <option value="admin">Administration</option>
          <option value="dev">Developpement</option>
        </select>
      </div>

      <header class="main-header">
        <div class="header-content">
          <div class="header-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 9H9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h1>Import Excel vers Grist</h1>
          <p class="subtitle">Importez vos donnees Excel avec gestion intelligente des doublons</p>
        </div>
      </header>

      <!-- Etape 1 : Chargement du fichier Excel -->
      <section class="card" data-mode="public dev">
        <div class="card-header">
          <h2>1. Selection du fichier</h2>
        </div>
        <div class="file-upload-area">
          <div class="file-input-wrapper">
            <input type="file" id="file-input" accept=".xlsx,.xls,.csv" />
            <label for="file-input" class="file-input-label">
              <div class="upload-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M14 2V8H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 13H8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 17H8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M10 9H9H8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <span class="upload-text">Choisir un fichier</span>
              <span class="upload-hint">Formats : .xlsx, .xls, .csv</span>
            </label>
          </div>
          <div id="file-name" class="file-selected"></div>
        </div>
      </section>

      <!-- Selecteur d'onglets (affiche dynamiquement si multi-onglets) -->
      <section class="card" data-mode="public dev" id="sheet-selector-section" style="display:none">
        <div class="card-header">
          <h2>Onglets du fichier</h2>
          <p>Selectionnez les onglets a importer</p>
        </div>
        <div id="sheet-selector-container" class="sheet-selector-area"></div>
      </section>

      <!-- Etape 2 : Previsualisation des donnees -->
      <section class="card" data-mode="dev">
        <div class="card-header">
          <h2>2. Previsualisation des donnees</h2>
        </div>
        <div id="preview-container">
          <div class="table-wrapper"></div>
        </div>
        <div class="column-selector">
          <label for="column-list">Colonnes detectees :</label>
          <select id="column-list"></select>
        </div>
      </section>

      <!-- Bouton retour a l'import (visible uniquement en mode admin) -->
      <button id="admin-back-btn" class="btn btn-secondary admin-back-btn" style="display:none">
        ← Retour a l'import
      </button>

      <!-- Bandeau explicatif admin (visible uniquement en mode admin) -->
      <section class="card admin-info-banner" data-mode="admin">
        <p><strong>Configuration de l'import</strong> — Les modifications sont enregistrees automatiquement. Definissez les regles de correspondance et les cles de deduplication ci-dessous, puis revenez a l'import.</p>
      </section>

      <!-- Etape 3 : Regles de correspondance (admin/dev) -->
      <section class="card" data-mode="admin dev">
        <div class="card-header">
          <h2>3. Configuration des regles d'import</h2>
          <p>Definissez le comportement pour chaque champ lors de l'import. Les modifications sont enregistrees instantanement.</p>
        </div>
        <div id="grist-rules-table" class="rules-grid"></div>
      </section>

      <!-- Etape 4 : Cle de doublon composite/fallback (admin/dev) -->
      <section class="card" data-mode="admin dev">
        <div class="card-header">
          <h2>4. Cle(s) unique(s) pour les doublons</h2>
          <p>Cochez une ou plusieurs colonnes pour identifier les doublons</p>
        </div>
        <div class="form-group">
          <div class="key-mode-selector">
            <label class="key-mode-label">
              <input type="radio" name="key-mode" value="composite" id="key-mode-composite" checked />
              <span><strong>Composite</strong> - Toutes les cles combinees forment un identifiant unique</span>
            </label>
            <label class="key-mode-label">
              <input type="radio" name="key-mode" value="fallback" id="key-mode-fallback" />
              <span><strong>Fallback</strong> - Si la cle 1 est vide, utilise la cle 2, etc. (ordre de priorite)</span>
            </label>
          </div>
          <div id="unique-key-checkboxes" class="unique-key-checkboxes"></div>
        </div>
      </section>

      <!-- Etape 5 : Mapping, validation & import -->
      <section class="card" data-mode="public dev">
        <div class="card-header">
          <h2>5. Import des donnees</h2>
          <p>Lancez l'import avec les parametres configures</p>
        </div>

        <div class="import-actions">
          <button id="match-columns-button" class="btn btn-secondary">
            Faire correspondre les colonnes
          </button>

          <div id="mapping-preview" class="mapping-preview"></div>

          <!-- Rapport de validation -->
          <div id="validation-report" class="validation-report" style="display:none"></div>

          <!-- Barre de progression -->
          <div id="progress-container" style="display:none"></div>

          <div class="import-buttons-row">
            <button id="dry-run-btn" class="btn btn-secondary">
              Simuler l'import
            </button>
            <button id="launch-import-btn" class="btn btn-primary btn-large">
              Lancer l'import
            </button>
            <button id="rollback-btn" class="btn btn-danger" style="display:none">
              Annuler le dernier import
            </button>
          </div>
        </div>

        <div id="import-status" class="import-status"></div>
      </section>
    </div>

    <!-- Scripts -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script type="module" src="src/app.js"></script>
  </body>
</html>
